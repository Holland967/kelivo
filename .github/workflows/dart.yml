name: Flutter Multi-Platform Build Stable

env:
  FLUTTER_VERSION: '3.35.7'  # ä¿®æ”¹ä¸ºä½ éœ€è¦çš„ Flutter ç‰ˆæœ¬

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      # é€‰æ‹©æ„å»ºçš„å¹³å°
      build_android:
        description: 'æ„å»º Android'
        required: false
        default: true
        type: boolean

      # æ˜¯å¦å‘å¸ƒåˆ° Releaseï¼ˆé»˜è®¤ä¸å‘å¸ƒï¼‰
      publish_release:
        description: 'å‘å¸ƒåˆ° Release'
        required: false
        default: false
        type: boolean

      # Release æ ‡ç­¾ï¼ˆåªæœ‰é€‰æ‹©å‘å¸ƒæ—¶æ‰éœ€è¦å¡«å†™ï¼‰
      release_tag:
        description: 'Release æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰'
        required: false
        default: ''
        type: string
  push:
    branches: [ main ]

jobs:
  # Android æ„å»º
  android:
    if: ${{ github.event.inputs.build_android == 'true' }}
    name: æ„å»º Android
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      - name: ğŸ“¦ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• é…ç½® Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ¦ å®‰è£… Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ğŸ“ Inject fallback
        shell: bash
        run: |
          mkdir -p lib/secrets
          cat > lib/secrets/fallback.dart <<'EOF'
          const String siliconflowFallbackKey = '${{ secrets.SILICONFLOW_KEY }}';
          EOF
      - name: ğŸ“ è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ç‰ˆæœ¬å·: $VERSION"
      # å¦‚æœæœ‰ç­¾åå¯†é’¥ï¼Œå†™å…¥å¯†é’¥æ–‡ä»¶
      - name: ğŸ”‘ å†™å…¥ç­¾åå¯†é’¥
        if: ${{ env.SIGN_KEYSTORE_BASE64 != '' }}
        env:
          SIGN_KEYSTORE_BASE64: ${{ secrets.SIGN_KEYSTORE_BASE64 }}
        run: |
          echo "$SIGN_KEYSTORE_BASE64" | base64 --decode > android/app/key.jks
          echo "storeFile=key.jks" >> android/key.properties
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "âœ… ç­¾åé…ç½®å·²å†™å…¥"
      - name: ğŸ—ï¸ æ„å»º APK
        run: flutter build apk --release --split-per-abi

      - name: ğŸ“¦ é‡å‘½å APK
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*-release.apk; do
            abi=$(echo "$file" | sed -E 's/app-(.*)-release\.apk/\1/')
            mv "$file" "Kelivo_android_${VERSION}_${abi}.apk"
          done
      - name: ğŸš€ å‘å¸ƒåˆ° Release
        if: ${{ github.event.inputs.publish_release == 'true' && github.event.inputs.release_tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_tag }}
          files: build/app/outputs/flutter-apk/Kelivo_android_*.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (arm64-v8a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-arm64-v8a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_arm64-v8a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (armeabi-v7a)
        uses: actions/upload-artifact@v4
        with:
          name: Android-armeabi-v7a
          path: build/app/outputs/flutter-apk/Kelivo_android_*_armeabi-v7a.apk

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰© (x86_64)
        uses: actions/upload-artifact@v4
        with:
          name: Android-x86_64
          path: build/app/outputs/flutter-apk/Kelivo_android_*_x86_64.apk
